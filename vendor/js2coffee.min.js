var Builder,Code,Node,Transformer,Typenames,Types,UnsupportedError,blockTrim,buildCoffee,exports,indentLines,isSingleLine,ltrim,p,paren,parser,rtrim,strEscape,strRepeat,trim,truthy,unreserve,unshift,_,_ref,_ref1,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1},__slice=[].slice,__hasProp={}.hasOwnProperty;parser=(this.Narcissus||require("./narcissus_packed")).parser;_=this._||require("underscore");_ref=this.NodeExt||require("./node_ext"),Types=_ref.Types,Typenames=_ref.Typenames,Node=_ref.Node;_ref1=this.Js2coffeeHelpers||require("./helpers"),Code=_ref1.Code,p=_ref1.p,strEscape=_ref1.strEscape,unreserve=_ref1.unreserve,unshift=_ref1.unshift,isSingleLine=_ref1.isSingleLine,trim=_ref1.trim,blockTrim=_ref1.blockTrim,ltrim=_ref1.ltrim,rtrim=_ref1.rtrim,strRepeat=_ref1.strRepeat,paren=_ref1.paren,truthy=_ref1.truthy,indentLines=_ref1.indentLines;buildCoffee=function(m,i){var n,d,g,o,q,f,k,e,a,t,j,r,h,b,s,c;if(i==null){i={}}m=m.replace(/\r/g,"");m+="\n";n=new Builder(i);j=parser.parse(m);e=trim(n.build(j));if(i.no_comments){return((function(){var v,u,w,l;w=e.split("\n");l=[];for(v=0,u=w.length;v<u;v++){f=w[v];l.push(rtrim(f))}return l})()).join("\n")}else{o=i.show_src_lineno;t=[];c=e.split("\n");for(b=0,s=c.length;b<s;b++){q=c[b];r=[];h=q.replace(/\uFEFE([0-9]+).*?\uFEFE/g,function(l,u){r.push(parseInt(u));return""});r=_.sortBy(_.uniq(r),function(l){return l});h=rtrim(h);g=h.match(/^\s*/);if(r.length>0){k=_.last(r);a=n.commentsNotDoneTo(k);if(a){t.push(indentLines(g,a))}}if(h){if(o){h=h+"#"+r.join(",")+"#  "}t.push(rtrim(h+" "+ltrim(n.lineComments(r))))}else{t.push("")}}d=n.commentsNotDoneTo(10000000000);if(d){t.push(d)}return t.join("\n")}};Builder=(function(){function a(b){this.options=b!=null?b:{};this.transformer=new Transformer}a.prototype.l=function(b){if(this.options.no_comments){return""}if(b&&b.lineno){return"\uFEFE"+b.lineno+"\uFEFE"}else{return""}};a.prototype.makeComment=function(e){var d,b;if(e.type==="BLOCK_COMMENT"){d=e.value.split("\n");if(d.length>0&&d[0].length>0&&d[0][0]==="*"){d=(function(){var g,f,c;c=[];for(g=0,f=d.length;g<f;g++){b=d[g];c.push(b.replace(/^[\s\*]*/,""))}return c})();d=(function(){var g,f,c;c=[];for(g=0,f=d.length;g<f;g++){b=d[g];c.push(b.replace(/[\s]*$/,""))}return c})();while(d.length>0&&d[0].length===0){d.shift()}while(d.length>0&&d[d.length-1].length===0){d.pop()}d.unshift("###");d.push("###")}else{d=(function(){var g,f,c;c=[];for(g=0,f=d.length;g<f;g++){b=d[g];c.push("#"+b)}return c})()}}else{d=["#"+e.value]}if(e.nlcount>0){d.unshift("")}return d.join("\n")};a.prototype.commentsNotDoneTo=function(d){var e,b;b=[];while(true){if(this.comments.length===0){break}e=this.comments[0];if(e.lineno<d){b.push(this.makeComment(e));this.comments.shift();continue}break}return b.join("\n")};a.prototype.lineComments=function(d){var e,b;b=(function(){var g,f,i,h,c;i=this.comments;c=[];for(g=0,f=i.length;g<f;g++){e=i[g];if(h=e.lineno,__indexOf.call(d,h)>=0){c.push(e)}}return c}).call(this);this.comments=_.difference(this.comments,b);return((function(){var g,f,c;c=[];for(g=0,f=b.length;g<f;g++){e=b[g];c.push(this.makeComment(e))}return c}).call(this)).join("\n")};a.prototype.build=function(){var d,e,c,f,b;d=1<=arguments.length?__slice.call(arguments,0):[];f=d[0];if(!(this.comments!=null)){this.comments=_.sortBy(f.tokenizer.comments,function(g){return g.start})}this.transform(f);c="other";if(f!==void 0&&f.typeName){c=f.typeName()}e=this[c]||this.other;b=e.apply(this,d);if(f.parenthesized){return paren(b)}else{return b}};a.prototype.transform=function(){var b;b=1<=arguments.length?__slice.call(arguments,0):[];return this.transformer.transform.apply(this.transformer,b)};a.prototype.body=function(c,b){var d;if(b==null){b={}}d=this.build(c,b);d=blockTrim(d);d=unshift(d);if(d.length>0){return d}else{return""}};a.prototype.script=function(f,b){var e,d=this;if(b==null){b={}}e=new Code;_.each(f.functions,function(c){return e.add(d.build(c))});_.each(f.nonfunctions,function(c){return e.add(d.build(c))});return e.toString()};a.prototype.property_identifier=function(c){var b;b=c.value.toString();if(b.match(/^([_\$a-z][_\$a-z0-9]*)$/i)||b.match(/^[0-9]+$/i)){return this.l(c)+b}else{return this.l(c)+strEscape(b)}};a.prototype.identifier=function(b){if(b.value==="undefined"){return this.l(b)+"`undefined`"}else{if(b.property_accessor){return this.l(b)+b.value.toString()}else{return this.l(b)+unreserve(b.value.toString())}}};a.prototype.number=function(b){return this.l(b)+(""+(b.src()))};a.prototype.id=function(b){if(b.property_accessor){return this.l(b)+b}else{return this.l(b)+unreserve(b)}};a.prototype.id_param=function(c){var b;if((b=c.toString())==="undefined"){return this.l(c)+(""+c+"_")}else{return this.l(c)+this.id(c)}};a.prototype["return"]=function(b){if(!(b.value!=null)){return this.l(b)+"return\n"}else{return this.l(b)+("return "+(this.build(b.value))+"\n")}};a.prototype[";"]=function(c){var b;if(c.expression==null){return""}else{if(c.expression.typeName()==="object_init"){b=this.object_init(c.expression);if(c.parenthesized){return b}else{return""+(unshift(blockTrim(b)))+"\n"}}else{return this.build(c.expression)+"\n"}}};a.prototype["new"]=function(b){return this.l(b)+("new "+(this.build(b.left())))};a.prototype.new_with_args=function(b){return this.l(b)+("new "+(this.build(b.left()))+"("+(this.build(b.right()))+")")};a.prototype.unary_plus=function(b){return"+"+(this.build(b.left()))};a.prototype.unary_minus=function(b){return"-"+(this.build(b.left()))};a.prototype["this"]=function(b){return this.l(b)+"this"};a.prototype["null"]=function(b){return this.l(b)+"null"};a.prototype["true"]=function(b){return this.l(b)+"true"};a.prototype["false"]=function(b){return this.l(b)+"false"};a.prototype["void"]=function(b){return this.l(b)+"undefined"};a.prototype["debugger"]=function(b){return this.l(b)+"debugger\n"};a.prototype["break"]=function(b){return this.l(b)+"break\n"};a.prototype["continue"]=function(b){return this.l(b)+"continue\n"};a.prototype["~"]=function(b){return"~"+(this.build(b.left()))};a.prototype["typeof"]=function(b){return this.l(b)+("typeof "+(this.build(b.left())))};a.prototype.index=function(c){var b;b=this.build(c.right());if(_.any(c.children,function(d){return d.typeName()==="object_init"&&d.children.length>1})){b="{"+b+"}"}return this.l(c)+(""+(this.build(c.left()))+"["+b+"]")};a.prototype["throw"]=function(b){return this.l(b)+("throw "+(this.build(b.exception)))};a.prototype["!"]=function(d){var b,c;c=d.left();b=1;while((c.isA("!"))&&(c=c.left())){++b}if((b&1)&&c.isA("==","!=","===","!==","in","instanceof")){c.negated=!c.negated;return this.build(c)}return this.l(d)+(""+(b&1?"not ":"!!")+(this.build(c)))};a.prototype["in"]=function(b){return this.binary_operator(b,"of")};a.prototype["+"]=function(b){return this.binary_operator(b,"+")};a.prototype["-"]=function(b){return this.binary_operator(b,"-")};a.prototype["*"]=function(b){return this.binary_operator(b,"*")};a.prototype["/"]=function(b){return this.binary_operator(b,"/")};a.prototype["%"]=function(b){return this.binary_operator(b,"%")};a.prototype[">"]=function(b){return this.binary_operator(b,">")};a.prototype["<"]=function(b){return this.binary_operator(b,"<")};a.prototype["&"]=function(b){return this.binary_operator(b,"&")};a.prototype["|"]=function(b){return this.binary_operator(b,"|")};a.prototype["^"]=function(b){return this.binary_operator(b,"^")};a.prototype["&&"]=function(b){return this.binary_operator(b,"and")};a.prototype["||"]=function(b){return this.binary_operator(b,"or")};a.prototype["<<"]=function(b){return this.binary_operator(b,"<<")};a.prototype["<="]=function(b){return this.binary_operator(b,"<=")};a.prototype[">>"]=function(b){return this.binary_operator(b,">>")};a.prototype[">="]=function(b){return this.binary_operator(b,">=")};a.prototype["==="]=function(b){return this.binary_operator(b,"is")};a.prototype["!=="]=function(b){return this.binary_operator(b,"isnt")};a.prototype[">>>"]=function(b){return this.binary_operator(b,">>>")};a.prototype["instanceof"]=function(b){return this.binary_operator(b,"instanceof")};a.prototype["=="]=function(b){return this.binary_operator(b,"is")};a.prototype["!="]=function(b){return this.binary_operator(b,"isnt")};a.prototype.binary_operator=(function(){var d,c,b;d={is:"isnt","in":"not in",of:"not of","instanceof":"not instanceof"};for(c in d){if(!__hasProp.call(d,c)){continue}b=d[c];d[b]=c}return function(f,e){if(f.negated){e=d[e]}return this.l(f)+(""+(this.build(f.left()))+" "+e+" "+(this.build(f.right())))}})();a.prototype["--"]=function(b){return this.increment_decrement(b,"--")};a.prototype["++"]=function(b){return this.increment_decrement(b,"++")};a.prototype.increment_decrement=function(c,b){if(c.postfix){return this.l(c)+(""+(this.build(c.left()))+b)}else{return this.l(c)+(""+b+(this.build(c.left())))}};a.prototype["="]=function(c){var b;b=c.assignOp!=null?Types[c.assignOp]+"=":"=";return this.l(c)+(""+(this.build(c.left()))+" "+b+" "+(this.build(c.right())))};a.prototype[","]=function(d){var b,c=this;b=_.map(d.children,function(e){return c.l(e)+c.build(e)+"\n"});return b.join("")};a.prototype.regexp=function(f){var e,c,b,d;b=f.value.toString().match(/^\/(.*)\/([a-z]?)/);d=b[1];c=b[2];e=d[0];if(e===" "||e==="="){if(c.length>0){return this.l(f)+("RegExp("+(strEscape(d))+', "'+c+'")')}else{return this.l(f)+("RegExp("+(strEscape(d))+")")}}else{return this.l(f)+("/"+d+"/"+c)}};a.prototype.string=function(b){return this.l(b)+strEscape(b.value)};a.prototype.call=function(b){if(b.right().children.length===0){return(""+(this.build(b.left()))+"()")+this.l(b)}else{return(""+(this.build(b.left()))+"("+(this.build(b.right()))+")")+this.l(b)}};a.prototype.call_statement=function(c){var b;b=this.build(c.left());if(c.left().isA("function")){b=paren(b)}if(c.right().children.length===0){return(""+b+"()")+this.l(c)}else{return(""+b+" "+(this.build(c.right())))+this.l(c)}};a.prototype.list=function(d){var b,c=this;b=_.map(d.children,function(e){if(d.children.length>1){e.is_list_element=true}return c.build(e)});return this.l(d)+b.join(", ")};a.prototype["delete"]=function(d){var b,c=this;b=_.map(d.children,function(e){return c.build(e)});b=b.join(", ");return this.l(d)+("delete "+b+"\n")};a.prototype["."]=function(e){var d,b,c;d=this.build(e.left());c=e.right();c.property_accessor=true;b=this.build(c);if(e.isThis&&e.isPrototype){return this.l(e)+"@::"}else{if(e.isThis){return this.l(e)+("@"+b)}else{if(e.isPrototype){return this.l(e)+(""+d+"::")}else{if(e.left().isPrototype){return this.l(e)+(""+d+b)}else{return this.l(e)+(""+d+"."+b)}}}}};a.prototype["try"]=function(e){var d,b=this;d=new Code;d.add("try");d.scope(this.body(e.tryBlock));_.each(e.catchClauses,function(c){return d.add(b.build(c))});if(e.finallyBlock!=null){d.add("finally");d.scope(this.body(e.finallyBlock))}return this.l(e)+d};a.prototype["catch"]=function(e){var b,d;b=this.body(e.block);if(trim(b).length===0){return""}d=new Code;if(e.varName!=null){d.add("catch "+e.varName)}else{d.add("catch")}d.scope(this.body(e.block));return this.l(e)+d};a.prototype["?"]=function(b){return this.l(b)+("(if "+(this.build(b.left()))+" then "+(this.build(b.children[1]))+" else "+(this.build(b.children[2]))+")")};a.prototype["for"]=function(d){var b;b=new Code;if(d.setup!=null){b.add(""+(this.build(d.setup))+"\n")}if(d.condition!=null){b.add("while "+(this.build(d.condition))+"\n")}else{b.add("loop")}b.scope(this.body(d.body));if(d.update!=null){b.scope(this.body(d.update))}return this.l(d)+b};a.prototype.for_in=function(d){var b;b=new Code;b.add("for "+(this.build(d.iterator))+" of "+(this.build(d.object)));b.scope(this.body(d.body));return this.l(d)+b};a.prototype["while"]=function(g){var b,f,d,e;f=new Code;d=g.positive?"while":"until";b=this.body(g.body);if(truthy(g.condition)){e="loop"}else{e=""+d+" "+(this.build(g.condition))}if(isSingleLine(b)&&e!=="loop"){f.add(""+(trim(b))+"  "+e+"\n")}else{f.add(e);f.scope(b)}return this.l(g)+f};a.prototype["do"]=function(d){var b;b=new Code;b.add("loop");b.scope(this.body(d.body));if(d.condition!=null){b.scope("break unless "+(this.build(d.condition)))}return this.l(d)+b};a.prototype["if"]=function(f){var b,e,d;e=new Code;d=f.positive?"if":"unless";b=this.body(f.thenPart);f.condition.parenthesized=false;if(f.thenPart.isA("block")&&f.thenPart.children.length===0&&!(f.elsePart!=null)){console.log(f.thenPart);e.add(""+(this.build(f.condition))+"\n")}else{if(isSingleLine(b)&&!(f.elsePart!=null)){e.add(""+(trim(b))+"  "+d+" "+(this.build(f.condition))+"\n")}else{e.add(""+d+" "+(this.build(f.condition)));e.scope(this.body(f.thenPart));if(f.elsePart!=null){if(f.elsePart.typeName()==="if"){e.add("else "+(this.build(f.elsePart).toString()))}else{e.add(this.l(f.elsePart)+"else\n");e.scope(this.body(f.elsePart))}}}}return this.l(f)+e};a.prototype["switch"]=function(f){var e,b,d=this;e=new Code;e.add("switch "+(this.build(f.discriminant))+"\n");b=false;_.each(f.cases,function(c){var g;if(c.value==="default"){e.scope(d.l(c)+"else")}else{if(b===true){e.add(d.l(c)+(", "+(d.build(c.caseLabel))+"\n"))}else{e.add(d.l(c)+("  when "+(d.build(c.caseLabel))))}}if(d.body(c.statements).length===0){b=true}else{b=false;e.add("\n");e.scope(d.body(c.statements),2)}return g=false});return this.l(f)+e};a.prototype.existence_check=function(b){return this.l(b)+(""+(this.build(b.left()))+"?")};a.prototype.array_init=function(b){if(b.children.length===0){return this.l(b)+"[]"}else{return this.l(b)+("["+(this.list(b))+"]")}};a.prototype.property_init=function(d){var c,b;c=d.left();b=d.right();b.is_property_value=true;return""+(this.property_identifier(c))+": "+(this.build(b))};a.prototype.object_init=function(g,b){var f,d,e=this;if(b==null){b={}}if(g.children.length===0){return this.l(g)+"{}"}else{if(g.children.length===1&&!(g.is_property_value||g.is_list_element)){return this.build(g.children[0])}else{d=_.map(g.children,function(c){return e.build(c)});f=new Code(this,g);f.scope(d.join("\n"));if(b.brackets!=null){f="{"+f+"}"}return f}}};a.prototype["function"]=function(g){var b,f,d,e=this;f=new Code;d=_.map(g.params,function(c){if(c.constructor===String){return e.id_param(c)}else{return e.build(c)}});if(g.name){f.add(""+g.name+" = ")}if(g.params.length>0){f.add("("+(d.join(", "))+") ->")}else{f.add("->")}b=this.body(g.body);if(trim(b).length>0){f.scope(b)}else{f.add("\n")}return this.l(g)+f};a.prototype["var"]=function(d){var b,c=this;b=_.map(d.children,function(e){return""+(unreserve(e.value))+" = "+(e.initializer!=null?c.build(e.initializer):"undefined")});return this.l(d)+_.compact(b).join("\n")+"\n"};a.prototype.other=function(b){return this.unsupported(b,""+(b.typeName())+" is not supported yet")};a.prototype.getter=function(b){return this.unsupported(b,"getter syntax is not supported; use __defineGetter__")};a.prototype.setter=function(b){return this.unsupported(b,"setter syntax is not supported; use __defineSetter__")};a.prototype.label=function(b){return this.unsupported(b,"labels are not supported by CoffeeScript")};a.prototype["const"]=function(b){return this.unsupported(b,"consts are not supported by CoffeeScript")};a.prototype.block=function(){var b;b=1<=arguments.length?__slice.call(arguments,0):[];return this.script.apply(this,b)};a.prototype.unsupported=function(c,b){throw new UnsupportedError("Unsupported: "+b,c)};return a})();Transformer=(function(){function a(){}a.prototype.transform=function(){var b,d,e,c;b=1<=arguments.length?__slice.call(arguments,0):[];e=b[0];if(e.transformed!=null){return}c=e.typeName();d=this[c];if(d){d.apply(this,b);return e.transformed=true}};a.prototype.script=function(d){var b,c=this;d.functions=[];d.nonfunctions=[];_.each(d.children,function(e){if(e.isA("function")){return d.functions.push(e)}else{return d.nonfunctions.push(e)}});b=null;return _.each(d.nonfunctions,function(e){var f;if(e.expression!=null){f=e.expression;if((b!=null?b.isA("object_init"):void 0)&&f.isA("object_init")){e.parenthesized=true}else{e.parenthesized=false}return b=f}})};a.prototype["."]=function(b){b.isThis=b.left().isA("this");return b.isPrototype=b.right().isA("identifier")&&b.right().value==="prototype"};a.prototype[";"]=function(b){if(b.expression!=null){b.expression.parenthesized=false;if(b.expression.isA("call")){b.expression.type=Typenames.call_statement;return this.call_statement(b)}}};a.prototype["function"]=function(b){return b.body.walk({last:true},function(c,e,f){var d;if(e.isA("return")&&e.value){d=f?c[f]:c.children[c.children.length-1];if(d){d.type=Typenames[";"];return d.expression=d.value}}})};a.prototype["switch"]=function(c){var b=this;return _.each(c.cases,function(e){var f,d,g;f=e.statements;d=f.children;if((g=f.last())!=null?g.isA("break"):void 0){return delete d[d.length-1]}})};a.prototype.call_statement=function(b){if(b.children[1]){return _.each(b.children[1].children,function(d,c){if(d.isA("function")&&c!==b.children[1].children.length-1){return d.parenthesized=true}})}};a.prototype["return"]=function(b){if(b.value&&b.value.isA("object_init")&&b.value.children.length>1){return b.value.parenthesized=true}};a.prototype.block=function(b){return this.script(b)};a.prototype["if"]=function(c){var b;if(c.thenPart.children.length===0&&((b=c.elsePart)!=null?b.children.length:void 0)>0){c.positive=false;c.thenPart=c.elsePart;delete c.elsePart}return this.inversible(c)};a.prototype["while"]=function(b){if(b.body.children.length===0){b.body.children.push(b.clone({type:Typenames["continue"],value:"continue",children:[]}))}return this.inversible(b)};a.prototype.inversible=function(c){var b;this.transform(c.condition);b=c.positive!=null?c.positive:true;if(c.condition.isA("!=")){c.condition.type=Typenames["=="];return c.positive=!b}else{if(c.condition.isA("!")){c.condition=c.condition.left();return c.positive=!b}else{return c.positive=b}}};a.prototype["=="]=function(b){if(b.right().isA("null","void")){b.type=Typenames["!"];return b.children=[b.clone({type:Typenames.existence_check,children:[b.left()]})]}};a.prototype["!="]=function(b){if(b.right().isA("null","void")){b.type=Typenames.existence_check;return b.children=[b.left()]}};return a})();UnsupportedError=(function(){function a(c,b){this.message=c;this.cursor=b.start;this.line=b.lineno;this.source=b.tokenizer.source}a.prototype.toString=function(){return this.message};return a})();this.Js2coffee=exports={VERSION:"0.1.3",build:buildCoffee,UnsupportedError:UnsupportedError};if(typeof module!=="undefined"&&module!==null){module.exports=exports};